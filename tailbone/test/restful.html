<!doctype html>
<html>
  <head>
    <title></title>
    <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-git.css">
  </head>
  <body>
  <div id="qunit"></div>
  <script src="//code.jquery.com/qunit/qunit-git.js" type="text/javascript"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
  <script src="/_ah/channel/jsapi" type="text/javascript" charset="utf-8"></script>
  <script src="/tailbone.base.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript">

var models = '/api/todos/';

module('Authentication');
asyncTest('Login', function() {
  http.GET('/api/users/me', function(d) {
    ok(d.Id !== undefined, 'Has Id, ' + d.Id);
    ok(d.email !== undefined, 'Has email, ' + d.email);
    start();
  }, function(err) {
    if(err.error !== 'LoginError') {
      throw new Error('Fatal login error message is incorrect.')
    }
    var url = window.location.href;
    window.location.href = '/api/login?continue=' + url;
  });
});

module('Creating Models'); 
asyncTest('String field', function() {
  var todo = {text: 'stuff'};
  http.POST(models, todo, function(d) {
    ok(d.text == 'stuff', 'Created model with string property.');
    http.DELETE(models + d.Id);
    start();
  });
});
asyncTest('Boolean field', function() {
  var todo = {text: true};
  http.POST(models, todo, function(d) {
    ok(d.text == true, 'Created model with boolean property.');
    http.DELETE(models + d.Id);
    start();
  });
});
asyncTest('Number field', function() {
  var todo = {count: 33};
  http.POST(models, todo, function(d) {
    ok(d.count == 33, 'Saved number.');
    http.DELETE(models + d.Id);
    start();
  });
});
asyncTest('Float field', function() {
  var todo = {count: 33.233};
  http.POST(models, todo, function(d) {
    ok(d.count == 33.233, 'Saved float.');
    http.DELETE(models + d.Id);
    start();
  });
});
asyncTest('Large text', function() {
  var text = new Array(1000).join("loremipsum");
  var todo = {text: text};
  http.POST(models, todo, function(d) {
    ok(d.text == text, 'Saved large text.');
    http.DELETE(models + d.Id);
    start();
  });
});
asyncTest('List', function() {
  var todo = {text: ['stuff','thing']};
  http.POST(models, todo, function(d) {
    todo.owners = d.owners;
    todo.viewers = d.viewers;
    todo.Id = d.Id;
    deepEqual(d, todo, 'Saved a list')
    http.DELETE(models + d.Id);
    start();
  });
});
asyncTest('Complex object', function() {
  var todo = {obj: {text: 'stuff'}};
  http.POST(models, todo, function(d) {
    todo.owners = d.owners;
    todo.viewers = d.viewers;
    todo.Id = d.Id;
    deepEqual(d, todo, 'Saved a complex object')
    http.DELETE(models + d.Id);
    start();
  });
});
asyncTest('GeoPt', function() {
  var todo = {pos: {lat: 33.3, lon: 44.4}};
  http.POST(models, todo, function(d) {
    deepEqual(d.pos, todo.pos, 'Saved GeoPt.')
    http.DELETE(models + d.Id);
    start();
  });
});
asyncTest('Datetime', function() {
  var todo = {date: new Date()};
  http.POST(models, todo, function(d) {
    deepEqual(d.date, todo.date, 'Saved datetime.');
    http.DELETE(models + d.Id);
    start();
  });
});
asyncTest('Combined', function() {
  var todo = {
    f: 333.000034,
    i: 322332212,
    list: ["stuff", "and", "things"],
    pos: {lat: 33.3, lon: 44.4},
    obj: {
      word: "words",
      num: 33.4
    },
    title: "title",
    text: new Array(1000).join("loremipsum"),
    date: new Date()
  };
  http.POST(models, todo, function(d) {
    todo.owners = d.owners;
    todo.viewers = d.viewers;
    todo.Id = d.Id;
    deepEqual(d, todo, 'Saved a combined complex object.');
    http.DELETE(models + d.Id);
    start();
  });
});

module('Retrieving Models');
asyncTest('Get by Id', function() {
  var todo = {text: 'stuff'};
  http.POST(models, todo, function(d) {
    http.GET(models + d.Id, function(d) {
      ok(d.text == 'stuff', 'Fetched model.');
      http.DELETE(models + d.Id);
      start();
    });
  });
});
asyncTest('Simple filters', function() {
  var todo = {
    f: 333.000034,
    i: 322332212,
    title: "title"
  };
  http.POST(models, todo, function(d) {
    var counter = 9;
    function done() { 
      if (--counter <= 0) {
        http.DELETE(models + d.Id);
        start();
      }
    }
    var expected = [d];
    setTimeout(function() {
      $.each(todo, function(k, v) {
        var filter1 = k + '==' + v;
        http.GET(models + '?filter=' + filter1, function(d) {
          deepEqual(d, expected, 'Correctly queried with filter: ' + filter1);
          done();
        });
        var filter2 = k + '<' + (v + 1);
        http.GET(models + '?filter=' + filter2, function(d) {
          deepEqual(d, expected, 'Correctly queried with filter: ' + filter2);
          done();
        });
        var filter3 = k + '>' + (v + 1);
        http.GET(models + '?filter=' + filter3, function(d) {
          deepEqual(d, [], 'Correctly queried with filter: ' + filter3);
          done();
        });
      });
    }, 500);
  });
});
asyncTest('Subobject', function() {
  var todo = {
    universe: {
      ans: 42
    }
  };
  http.POST(models, todo, function(d) {
    var filter = 'universe.ans==42';
    var expected = [d];
    var id = d.Id;
    setTimeout(function() {
      http.GET(models + '?filter=' + filter, function(d) {
        deepEqual(d, expected, 'Correctly queried with filter: ' + filter);
        http.DELETE(models + id);
        start();
      });
    }, 500);
  });
});
// asyncTest('AND filter', function() {});
// asyncTest('OR filter', function() {});
// asyncTest('projection', function() {});
// asyncTest('order', function() {});
// asyncTest('By params JSON string', function() {});

module('Delete Models');
asyncTest('Delete by Id', function() {
  http.POST(models, {}, function(d) {
    http.DELETE(models + d.Id, function(d) {
      ok(d.error === undefined, "No errors.");
      start();
    });
  });
});

module('Users');

module('Validation');

  </script>
  </body>
</html>